/**
 * Copyright (C) 2012, Christopher Mullins ( chris.mullins10@gmail.com )
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a 
 * copy of this software and associated documentation files (the "Software"), 
 * to deal in the Software without restriction, including without limitation 
 * the rights to use, copy, modify, merge, publish, distribute, sublicense, 
 * and/or sell copies of the Software, and to permit persons to whom the 
 * Software is furnished to do so, subject to the following conditions: 
 * 
 * The above copyright notice and this permission notice shall be included in 
 * all copies or substantial portions of the Software. 
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR 
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER 
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING 
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER 
 * DEALINGS IN THE SOFTWARE. 
 */
!function(t){function e(t,e){this.venn=t,this.data=t.data("venn"),this.settings=this.data.settings,this.containedSets=e,this.active=!1,this.shadingLines=null;var i=function(t,e){return t.data("index")-e.data("index")};this.containedSets=this.containedSets.sort(i)}function i(){for(var t={},i=this.data("venn"),n=i.set,a=i.settings,r=.05*Math.max(i.bbox.width,a.canvasWidth),s=0;s<this.width();s+=r)for(var o=0;o<this.height();o+=r){var h=s+r,g=o+r,c=l(h,g,n),d=e.getHashKey(c);t[d]=[h,g]}return t}function n(t,i){if(0==i.length)return[new e(t,[])];for(var a=n(t,i.slice(1)),r=[],s=0;s<a.length;s++)r.push(a[s]),r.push(a[s].union([i[0]]));return r}function a(t,e,i){for(var n=.3*t.canvasWidth/2,a=t.canvasWidth/2,r=t.canvasHeight/2,s=[e.ellipse(a-n/2,r,n,n),e.ellipse(a+n/2,r,n,n)],o=0;o<s.length;o++){var h=s[o];h.attr("stroke",t.colors[o]).data("index",o);for(var l=0;l<t.ellipseSettings.length;l++)h.attr(l,t.ellipseSettings[l]);var g,c,d=h.attr("cx"),f=h.attr("cy");0==o?(g=d-.75*n,c=f):(g=d+.75*n,c=f);var v=e.text(g,c,t.setLabels[o]).attr("font-size","10").attr("font-weight","bold"),u=v.getBBox();e.rect(u.x-4,u.y-2,u.width+8,u.height+4).attr("fill",t.backgroundColor).attr("stroke-width",0).toBack()}return s}function r(t,e,i){for(var n=.32*t.canvasWidth/2,a=t.canvasWidth/2,r=t.canvasHeight/2+n/3,s=e.set(),o=[e.ellipse(a-n/2,r-.75*n,n,n),e.ellipse(a+n/2,r-.75*n,n,n),e.ellipse(a,r,n,n)],h=[],l=0;l<o.length;l++){var g=o[l];s.push(g),g.attr("stroke",t.colors[l]).data("index",l);for(var c in t.ellipseSettings)g.attr(c,t.ellipseSettings[c]);var d,f,v=g.attr("cx"),u=g.attr("cy");0==l?(d=v-n/2,f=u-n/2):1==l?(d=v+n/2,f=u-n/2):(d=v,f=u+.75*n);var p=e.text(d,f,t.setLabels[l]).attr("font-size","10").attr("font-weight","bold").toBack(),y=p.getBBox(),x=e.rect(y.x-4,y.y-2,y.width+8,y.height+4).attr("fill",t.backgroundColor).attr("stroke-width",0).toBack();s.push(p).push(x),h.push(e.set().push(p).push(x))}var b=s.getBBox(),k=b.x+b.width/2,S=b.y+b.height/2;s.rotate(90,k,S);for(var l=0;l<h.length;l++)h[l].rotate(-90);return o}function s(t,e,i){for(var n=.1*t.canvasWidth,a=.25*t.canvasWidth,r=1.6*a+n,s=t.canvasHeight/2+1.25*n,o=[e.ellipse(r+a,s,n,a).rotate(-70,r,s+a),e.ellipse(r+a,s,n,a).rotate(-65,r,s+a).translate(a/3,n/2),e.ellipse(r-a,s,n,a).rotate(65,r,s+a).translate(-a/3,n/2),e.ellipse(r-a,s,n,a).rotate(70,r,s+a)],h=0;h<o.length;h++){var l=o[h];l.attr("stroke",t.colors[h]).data("index",h);for(var g=0;g<t.ellipseSettings;g++)l.attr(g,t.ellipseSettings[g]);var c,d,f=l.attr("cx"),v=l.attr("cy")-l.attr("ry")+20;0==h||3==h?(c=l.matrix.x(f,v),d=l.matrix.y(f,v)):2==h?(c=l.matrix.x(f,v)-30,d=l.matrix.y(f,v)-10):1==h&&(c=l.matrix.x(f,v)+30,d=l.matrix.y(f,v)-10);var u=e.text(c,d,t.setLabels[h]).attr("font-size","10").attr("font-weight","bold").toBack(),p=u.getBBox();e.rect(p.x-4,p.y-2,p.width+8,p.height+4).attr("fill",t.backgroundColor).attr("stroke-width",0).toBack()}return o}function o(){var t=this.data("venn"),e=t.settings,i="",n=t.regions[i];e.disableClicks||(n.toggleActive(),e.shadeRegions&&x(0,0,[],this),this.trigger("regionClicked.venn",t.regions[i]))}function h(t){var i=t.offsetX?t.offsetX:t.layerX,n=t.offsetY?t.offsetY:t.layerY,a=this.data("venn"),r=a.set,s=l(i,n,r),o=e.getHashKey(s);a.settings.disableClicks||(a.regions[o].toggleActive(),a.settings.shadeRegions&&x(i,n,s,this),this.trigger("regionClicked.venn",a.regions[o]))}function l(t,e,i){for(var n=[],a=0;a<i.length;a++)c(t,e,i[a])&&n.push(i[a]);return n}function g(t,e,i){var n=i.attr("cx"),a=i.attr("cy"),r=i.attr("rx"),s=i.attr("ry"),o=i.matrix.invert().x(t,e),h=i.matrix.invert().y(t,e),l=o-n,g=h-a;return l*l/(r*r)+g*g/(s*s)}function c(t,e,i){return g(t,e,i)<=1}function d(t,e,i){var n=Math.abs(g(t,e,i)-1);return n<Math.abs(g(t-1,e,i)-1)&&n<Math.abs(g(t+1,e,i)-1)?!0:!1}function f(t,e,i){for(var n=0;n<i.length;n++){var a=i[n];if(d(t,e,a))return n}return null}function v(t,e,i){for(var n=0;n<i.length;n++)if(g(t,e,i[n])>1)return!1;return!0}function u(t,e,i){for(var n=0;n<i.length;n++)if(g(t,e,i[n])<1)return!0;return!1}function p(t,e){for(var i=0;i<t.length;i++)if(t[i].data("index")==e.data("index"))return!0;return!1}function y(t,e){for(var i=[],n=0;n<t.length;n++)p(e,t[n])||i.push(t[n]);return i}function x(t,i,n,a){var r=e.getHashKey(n),s=a.data("venn"),o=s.settings,h=s.set,l=s.bbox,g=o.shadeSpacing,c=s.paper,d=y(h,n);if(s.regions[r].isActive())if(0==n.length)s.universe.attr("fill",o.shadeColor).attr("fill-opacity",o.universeShadeOpacity);else{for(var p=[],x=[],b=[-g,g],k=0;k<b.length;k++){var g=b[k],S=t,w=t,C=i;k>0&&(C+=g),p.length>0&&(S=x[0],w=x[0]);t:for(;;){for(;null==f(S-1,C,n)&&!u(S-1,C,d);)if(S--,S+10<l.x)break t;for(;null==f(w+1,C,n)&&!u(w+1,C,d);)if(w++,w-10>l.x+l.width)break t;if(!v(S,C,n)||!v(w,C,n)||u(S,C,d)||u(w,C,d))break t;p.push(c.path(Raphael.fullfill("M{startx},{starty}L{endx},{endy}",{startx:S,starty:C,endx:w,endy:C})).toBack()),S=Math.floor((w+S)/2),x.push(S),w=S,C+=g}}s.regions[r].shade(p)}else s.regions[r].unshade()}e.prototype.getHashKey=function(){return e.getHashKey(this.containedSets)},e.prototype.getArrayKey=function(){for(var t=[],e=0;e<this.containedSets.length;e++)t.push(this.containedSets[e].data("index"));return t.sort()},e.prototype.getId=function(){var t=this.settings.setLabels,i=this.getArrayKey();return e.arrayKeyToRegionLabel(i,t)},e.prototype.isActive=function(){return this.active},e.prototype.toggleActive=function(){this.setActive(!this.isActive())},e.prototype.setActive=function(t){this.active=t},e.prototype.unshade=function(){if(0==this.containedSets.length)this.data.universe.attr("fill-opacity",0);else{if("undefined"!=typeof this.shadingLines&&null!=this.shadingLines)for(var t=0;t<this.shadingLines.length;t++)this.shadingLines[t].remove();this.shadingLines=null}},e.prototype.shade=function(t){this.shadingLines=t},e.prototype.union=function(t){for(var i=this.containedSets.slice(),n=0;n<t.length;n++)i.push(t[n]);return new e(this.venn,i)},e.prototype.toString=function(){return this.getId()},e.prototype.getRepresentativeCoords=function(){return this.data.regionCoordinates[this.getHashKey()]},e.getHashKey=function(t){for(var e="",i=0;i<t.length;i++)e+=t[i].data("index")+",";return e},e.arrayKeyToRegionLabel=function(t,e){t=t.sort();for(var i="",n=0;n<t.length;n++)i+=e[t[n]];return i};var b={init:function(e){var l=t.extend({numSets:4,setLabels:["A","B","C","D"],universeLabel:"U",colors:["#f00","#0f0","#00f","#dd0"],backgroundColor:"#fff",borderColor:"#000",shadeRegions:!0,shadeSpacing:3,shadeColor:"#000",universeShadeOpacity:.3,ellipseSettings:{fill:"#fff","fill-opacity":0,"stroke-width":2},initRegions:[],disableClicks:!1,canvasWidth:"inherit",canvasHeight:"inherit",regionClicked:t.noop},e);"inherit"==l.canvasWidth&&(l.canvasWidth=this.width()),"inherit"==l.canvasHeight&&(l.canvasHeight=this.height());var g,c=this,d=Raphael(t(this)[0],l.canvasWidth,l.canvasHeight);g=4==l.numSets?s(l,d,this):3==l.numSets?r(l,d,this):a(l,d,this);for(var f=d.set(),v=0;v<g.length;v++)f.push(g[v]);var u=f.getBBox(),p=20,y=d.rect(u.x-p,u.y-p,u.width+2*p,u.height+2*p).attr("fill",l.universeShadeOpacity).attr("fill-opacity",0).attr("stroke-width",1).toBack();d.text(y.attr("x")+y.attr("width")-p/2,y.attr("y")+y.attr("height")-10,l.universeLabel).attr("font-size","10").attr("font-weight","bold").toBack(),f.click(function(t){h.apply(c,[t])}),y.click(function(t){o.apply(c)}),this.data("venn",{settings:l,paper:d,set:f,universe:y,bbox:u});for(var x=n(this,t.makeArray(f)),b={},v=0;v<x.length;v++)b[x[v].getHashKey()]=x[v];this.data("venn").regionCoordinates=i.call(c),this.data("venn").regions=b,this.bind("regionClicked.venn",l.regionClicked),this.height()<l.canvasHeight&&this.height(l.canvasHeight);for(var v=0;v<l.initRegions.length;v++)this.venn("activateRegion",l.initRegions[v]);return this},activeRegions:function(){for(var t=[],e=this.data("venn").regions,i=0;i<e.length;i++)e[i].isActive()&&t.push(e[i]);return t},activateRegion:function(t){var i=this.data("venn").settings,n=this.data("venn").regions;"object"==typeof t&&(t=e.arrayKeyToRegionLabel(t,i.setLabels));for(var a=0;a<n.length;a++)if(t==n[a].getId()&&!n[a].isActive()){n[a].toggleActive();var r=n[a].getRepresentativeCoords();i.shadeRegions&&x(r[0],r[1],n[a].containedSets,this);break}return this}};t.fn.venn=function(e){return b[e]?b[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?void t.error("Method "+e+"does not exist on jQuery.venn!"):b.init.apply(this,arguments)}}(jQuery);